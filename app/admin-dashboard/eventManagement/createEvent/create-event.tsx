"use client"

import { useState, useRef } from "react"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Save, Eye } from "lucide-react"
import { FormProgress } from "./form-progress"
import { BasicInfoTab } from "./basic-info-tab"
import { EventDetailsTab } from "./event-details-tab"
import { PricingTab } from "./pricing-tab"
import { MediaTab } from "./media-tab"
import { PreviewTab } from "./preview-tab"
import type { EventFormData } from "./types"

export function CreateEventForm() {
  const [activeTab, setActiveTab] = useState("basic")
  const [formData, setFormData] = useState<EventFormData>({
    title: "",
    slug: "",
    description: "",
    eventType: "Conference",
    categories: [],
    edition: 1,
    startDate: "",
    endDate: "",
    dailyStart: "",
    dailyEnd: "",
    timezone: "UTC",
    venueId: "",
    venue: "",
    city: "",
    address: "",
    currency: "USD",
    generalPrice: 0,
    studentPrice: 0,
    vipPrice: 0,
    groupPrice: 0,
    highlights: [""],
    tags: [],
    dressCode: "",
    ageLimit: "",
    featured: false,
    vip: false,
    spaceCosts: [],
    ticketTypes: [],
    images: [],
    brochure: "",
    layoutPlan: "",
    featuredHotels: [],
    travelPartners: [],
    touristAttractions: [],
    ageRestriction: "",
    accessibility: "",
    parking: "",
    publicTransport: "",
    foodBeverage: "",
    wifi: "",
    photography: "",
    recording: "",
    liveStreaming: "",
    socialMedia: "",
    networking: "",
    certificates: "",
    materials: "",
    followUp: "",
  })

  const [validationErrors, setValidationErrors] = useState({})
  const [newHighlight, setNewHighlight] = useState("")
  const [newTag, setNewTag] = useState("")
  const [isUploadingImages, setIsUploadingImages] = useState(false)
  const [isUploadingBrochure, setIsUploadingBrochure] = useState(false)
  const [isUploadingLayoutPlan, setIsUploadingLayoutPlan] = useState(false)

  const fileInputRef = useRef<HTMLInputElement>(null)
  const brochureInputRef = useRef<HTMLInputElement>(null)
  const layoutPlanInputRef = useRef<HTMLInputElement>(null)

  const handleFormChange = (updates: Partial<EventFormData>) => {
    setFormData((prev) => ({
      ...prev,
      ...updates,
    }))
  }

  const handleCategoryToggle = (category: string) => {
    setFormData((prev) => ({
      ...prev,
      categories: prev.categories.includes(category)
        ? prev.categories.filter((c) => c !== category)
        : [...prev.categories, category],
    }))
  }

  const handleVenueChange = (venueData: {
  venueId?: string
  venueName: string
  venueAddress: string
  city: string
}) => {
  setFormData((prev) => ({
    ...prev,
    venue: venueData.venueName, // âœ… just store name
    address: venueData.venueAddress,
    city: venueData.city,
  }))
}


  const handleAddHighlight = () => {
    if (newHighlight.trim()) {
      setFormData((prev) => ({
        ...prev,
        highlights: [...prev.highlights, newHighlight.trim()],
      }))
      setNewHighlight("")
    }
  }

  const handleRemoveHighlight = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      highlights: prev.highlights.filter((_, i) => i !== index),
    }))
  }

  const handleAddTag = () => {
    if (newTag.trim()) {
      setFormData((prev) => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()],
      }))
      setNewTag("")
    }
  }

  const handleRemoveTag = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      tags: prev.tags.filter((_, i) => i !== index),
    }))
  }

  const handleAddCustomSpaceCost = () => {
    setFormData((prev) => ({
      ...prev,
      spaceCosts: [
        ...prev.spaceCosts,
        {
          type: "",
          description: "",
          pricePerSqm: 0,
          minArea: 0,
          isFixed: false,
        },
      ],
    }))
  }

  const handleUpdateSpaceCost = (index: number, field: string, value: any) => {
    setFormData((prev) => ({
      ...prev,
      spaceCosts: prev.spaceCosts.map((cost, i) => (i === index ? { ...cost, [field]: value } : cost)),
    }))
  }

  const handleRemoveSpaceCost = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      spaceCosts: prev.spaceCosts.filter((_, i) => i !== index),
    }))
  }

  const handleRemoveImage = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      images: prev.images.filter((_, i) => i !== index),
    }))
  }

  const handlePublish = () => {
    console.log("Publishing event:", formData)
    // Add your publish logic here
  }

  const calculateProgress = () => {
    const fields = [
      formData.title,
      formData.startDate,
      formData.endDate,
      formData.venue,
      formData.description,
      formData.highlights.filter((h) => h.trim()).length > 0,
    ]
    const completed = fields.filter(Boolean).length
    return Math.round((completed / fields.length) * 100)
  }

  const eventTypes = ["Conference", "Exhibition", "Seminar", "Workshop", "Trade Show"]
  const eventCategories = ["Technology", "Healthcare", "Finance", "Education", "Entertainment"]
  const currencies = ["USD", "EUR", "GBP", "INR", "JPY"]

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Create New Event</CardTitle>
              <CardDescription>Fill in the details to create a new event on the platform</CardDescription>
            </div>
            <div className="flex items-center gap-2">
              <Button variant="outline" size="sm">
                <Save className="h-4 w-4 mr-2" />
                Save Draft
              </Button>
              <Button size="sm" onClick={handlePublish}>
                <Eye className="h-4 w-4 mr-2" />
                Publish Event
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <FormProgress completionPercentage={calculateProgress()} />

          <Tabs value={activeTab} onValueChange={setActiveTab} className="mt-6">
            <TabsList className="grid w-full grid-cols-5">
              <TabsTrigger value="basic">Basic Info</TabsTrigger>
              <TabsTrigger value="details">Event Details</TabsTrigger>
              <TabsTrigger value="pricing">Pricing</TabsTrigger>
              <TabsTrigger value="media">Media</TabsTrigger>
              <TabsTrigger value="preview">Preview</TabsTrigger>
            </TabsList>

            <TabsContent value="basic" className="space-y-6 mt-6">
              <BasicInfoTab
                formData={formData}
                validationErrors={validationErrors}
                eventTypes={eventTypes}
                eventCategories={eventCategories}
                onFormChange={handleFormChange}
                onCategoryToggle={handleCategoryToggle}
                onVenueChange={handleVenueChange}
              />
            </TabsContent>

            <TabsContent value="details" className="space-y-6 mt-6">
              <EventDetailsTab
                formData={formData}
                validationErrors={validationErrors}
                newHighlight={newHighlight}
                newTag={newTag}
                onFormChange={handleFormChange}
                onNewHighlightChange={setNewHighlight}
                onNewTagChange={setNewTag}
                onAddHighlight={handleAddHighlight}
                onRemoveHighlight={handleRemoveHighlight}
                onAddTag={handleAddTag}
                onRemoveTag={handleRemoveTag}
              />
            </TabsContent>

            <TabsContent value="pricing" className="space-y-6 mt-6">
              <PricingTab
                formData={formData}
                currencies={currencies}
                onFormChange={handleFormChange}
                onAddCustomSpaceCost={handleAddCustomSpaceCost}
                onUpdateSpaceCost={handleUpdateSpaceCost}
                onRemoveSpaceCost={handleRemoveSpaceCost}
              />
            </TabsContent>

            <TabsContent value="media" className="space-y-6 mt-6">
              <MediaTab
                formData={formData}
                isUploadingImages={isUploadingImages}
                isUploadingBrochure={isUploadingBrochure}
                isUploadingLayoutPlan={isUploadingLayoutPlan}
                fileInputRef={fileInputRef}
                brochureInputRef={brochureInputRef }
                layoutPlanInputRef={layoutPlanInputRef}
                onFormChange={handleFormChange}
                onRemoveImage={handleRemoveImage}
              />
            </TabsContent>

            <TabsContent value="preview" className="space-y-6 mt-6">
              <PreviewTab formData={formData} />
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  )
}
